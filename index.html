<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Arbre Généalogique - 15 Générations</title>
    <meta name="description" content="Application web gratuite pour créer et visualiser votre arbre généalogique sur 15 générations">
    <meta name="keywords" content="généalogie, arbre généalogique, famille, ancêtres, histoire familiale">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #27ae60;
            --warning: #f39c12;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .progress-container {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .progress-bar {
            height: 20px;
            background-color: #eee;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary), var(--success));
            width: 0%;
            transition: width 0.5s ease;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .sidebar {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow);
            height: fit-content;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            border: none;
            border-radius: 8px;
            background-color: var(--secondary);
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .btn i {
            margin-right: 10px;
        }

        .btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .btn-primary {
            background-color: var(--primary);
        }

        .btn-success {
            background-color: var(--success);
        }

        .btn-warning {
            background-color: var(--warning);
        }

        .person-count {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .person-count h3 {
            margin-bottom: 10px;
            color: var(--primary);
        }

        .person-count ul {
            list-style-type: none;
        }

        .person-count li {
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }

        .content-area {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: var(--shadow);
            min-height: 600px;
        }

        .tab-header {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 25px;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            font-weight: 600;
            color: #777;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--secondary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .form-section h3 {
            margin-bottom: 20px;
            color: var(--primary);
            display: flex;
            align-items: center;
        }

        .form-section h3 i {
            margin-right: 10px;
            color: var(--secondary);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, 
        .form-group textarea, 
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border 0.3s ease;
        }

        .form-group input:focus, 
        .form-group textarea:focus, 
        .form-group select:focus {
            border-color: var(--secondary);
            outline: none;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group small {
            color: #777;
            font-size: 0.85rem;
        }

        .photo-upload {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .photo-upload:hover {
            border-color: var(--secondary);
            background-color: #f8fafc;
        }

        .photo-upload i {
            font-size: 3rem;
            color: #ccc;
            margin-bottom: 15px;
        }

        .photo-preview {
            display: none;
            max-width: 200px;
            margin-top: 15px;
            border-radius: 8px;
            overflow: hidden;
        }

        .photo-preview img {
            width: 100%;
            height: auto;
        }

        .tree-container {
            width: 100%;
            height: 700px;
            overflow: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            background-color: #f9f9f9;
        }

        .person-node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .person-node:hover {
            transform: scale(1.05);
        }

        .person-card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: var(--shadow);
            width: 200px;
            text-align: center;
        }

        .person-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 10px;
            border: 3px solid var(--secondary);
        }

        .person-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--primary);
        }

        .person-dates {
            font-size: 0.9rem;
            color: #777;
            margin-bottom: 10px;
        }

        .person-location {
            font-size: 0.85rem;
            color: #999;
            margin-bottom: 5px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background-color: #f8fafc;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .stat-card i {
            font-size: 2.5rem;
            color: var(--secondary);
            margin-bottom: 15px;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .stat-label {
            color: #777;
            font-size: 1rem;
        }

        .timeline {
            position: relative;
            max-width: 1000px;
            margin: 0 auto;
        }

        .timeline::after {
            content: '';
            position: absolute;
            width: 6px;
            background-color: var(--secondary);
            top: 0;
            bottom: 0;
            left: 50%;
            margin-left: -3px;
        }

        .timeline-item {
            padding: 10px 40px;
            position: relative;
            width: 50%;
            box-sizing: border-box;
        }

        .timeline-item:nth-child(odd) {
            left: 0;
        }

        .timeline-item:nth-child(even) {
            left: 50%;
        }

        .timeline-content {
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: var(--shadow);
        }

        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .export-card {
            background-color: #f8fafc;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .export-card:hover {
            border-color: var(--secondary);
            transform: translateY(-5px);
        }

        .export-card i {
            font-size: 3rem;
            color: var(--secondary);
            margin-bottom: 15px;
        }

        .person-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .person-list-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .person-list-item:hover {
            background-color: #f8fafc;
        }

        .person-list-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            border: 2px solid #ddd;
        }

        .person-list-info h4 {
            margin-bottom: 5px;
            color: var(--primary);
        }

        .person-list-info p {
            font-size: 0.9rem;
            color: #777;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #777;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #777;
            border-top: 1px solid #eee;
        }

        .generation-info {
            background-color: #e8f4fc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid var(--secondary);
        }

        .generation-info h4 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .tooltip {
            position: absolute;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 5px;
            font-size: 0.9rem;
            pointer-events: none;
            z-index: 100;
            max-width: 300px;
        }

        /* Styles additionnels pour l'optimisation */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .loading.active {
            display: flex;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--secondary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .performance-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 0.9rem;
        }
        
        .virtual-list {
            max-height: 600px;
            overflow-y: auto;
            position: relative;
        }
        
        .virtual-list-item {
            position: absolute;
            width: 100%;
            box-sizing: border-box;
        }
        
        /* Optimisations pour D3 */
        .d3-node {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .d3-node:hover {
            filter: brightness(1.1);
            transform: scale(1.05);
        }
        
        .d3-link {
            transition: stroke 0.3s ease;
        }
        
        .d3-link:hover {
            stroke: var(--accent);
            stroke-width: 2.5px;
        }
    </style>
    <!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-XXXXXXXXX-X"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-XXXXXXXXX-X');
</script>
<!-- Google Drive API -->
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>   
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-tree"></i> Mon Arbre Généalogique</h1>
            <p>Reconstruisons mon histoire familiale sur 15 générations</p>
        </header>

        <div class="progress-container">
            <h3>Progression de mon arbre</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">Chargement...</p>
        </div>

        <div class="generation-info">
            <h4><i class="fas fa-info-circle"></i> 15 Générations Ascendantes</h4>
            <p>Un arbre sur 15 générations représente théoriquement <strong>16 384 ancêtres</strong> à la 15ème génération. Commencez par vous-même et remontez progressivement.</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <button class="btn btn-primary" id="btnNewPerson">
                    <i class="fas fa-user-plus"></i> Ajouter une personne
                </button>
                <button class="btn" id="btnViewTree">
                    <i class="fas fa-sitemap"></i> Voir l'arbre
                </button>
                <button class="btn" id="btnViewList">
                    <i class="fas fa-list"></i> Liste des personnes
                </button>
                <button class="btn" id="btnStats">
                    <i class="fas fa-chart-bar"></i> Statistiques
                </button>
                <button class="btn" id="btnTimeline">
                    <i class="fas fa-stream"></i> Chronologie
                </button>
                <button class="btn btn-warning" id="btnExport">
                    <i class="fas fa-download"></i> Exporter
                </button>
                <button class="btn btn-success" id="btnImport">
                    <i class="fas fa-upload"></i> Importer
                </button>

                <div class="person-count">
                    <h3><i class="fas fa-users"></i> Votre arbre</h3>
                    <ul id="personCountList">
                        <!-- Rempli dynamiquement -->
                    </ul>
                </div>

                <div class="person-count">
                    <h3><i class="fas fa-lightbulb"></i> Conseils</h3>
                    <p style="font-size: 0.9rem; margin-top: 10px;">
                        <i class="fas fa-check-circle" style="color: var(--success);"></i> Commencez par vous et vos parents
                        <br><br>
                        <i class="fas fa-check-circle" style="color: var(--success);"></i> Notez toutes vos sources
                        <br><br>
                        <i class="fas fa-check-circle" style="color: var(--success);"></i> Sauvegardez régulièrement
                    </p>
                </div>
            </div>

            <div class="content-area">
                <div class="tab-header">
                    <div class="tab active" data-tab="form">Formulaire</div>
                    <div class="tab" data-tab="tree">Arbre</div>
                    <div class="tab" data-tab="list">Liste</div>
                    <div class="tab" data-tab="stats">Statistiques</div>
                    <div class="tab" data-tab="timeline">Chronologie</div>
                    <div class="tab" data-tab="export">Export/Import</div>
                </div>

                <!-- Onglet Formulaire -->
                <div class="tab-content active" id="formTab">
                    <h2 style="color: var(--primary); margin-bottom: 20px;">
                        <i class="fas fa-user-edit"></i> Fiche personnelle
                    </h2>
                    
                    <form id="personForm">
                        <div class="form-section">
                            <h3><i class="fas fa-id-card"></i> Identité</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="lastName">Nom de famille *</label>
                                    <input type="text" id="lastName" name="lastName" required>
                                </div>
                                <div class="form-group">
                                    <label for="firstName">Prénom(s) *</label>
                                    <input type="text" id="firstName" name="firstName" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="nickname">Surnom(s)</label>
                                    <input type="text" id="nickname" name="nickname" placeholder="Surnoms, diminutifs...">
                                </div>
                                <div class="form-group">
                                    <label for="gender">Sexe</label>
                                    <select id="gender" name="gender">
                                        <option value="M">Masculin</option>
                                        <option value="F">Féminin</option>
                                        <option value="U">Inconnu</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3><i class="fas fa-calendar-alt"></i> Dates et lieux</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="birthDate">Date de naissance</label>
                                    <input type="date" id="birthDate" name="birthDate">
                                </div>
                                <div class="form-group">
                                    <label for="birthPlace">Lieu de naissance</label>
                                    <input type="text" id="birthPlace" name="birthPlace" placeholder="Ville, département, pays">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="deathDate">Date de décès</label>
                                    <input type="date" id="deathDate" name="deathDate">
                                </div>
                                <div class="form-group">
                                    <label for="deathPlace">Lieu de décès</label>
                                    <input type="text" id="deathPlace" name="deathPlace" placeholder="Ville, département, pays">
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3><i class="fas fa-briefcase"></i> Vie professionnelle et résidences</h3>
                            <div class="form-group">
                                <label for="professions">Profession(s)</label>
                                <textarea id="professions" name="professions" placeholder="Ex: Agriculteur (1945-1960), puis commerçant (1960-1980)"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="residences">Résidences</label>
                                <textarea id="residences" name="residences" placeholder="Ex: Bafang (1920-1965), Meiganga (1965-1980)"></textarea>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3><i class="fas fa-camera"></i> Photo et documents</h3>
                            <div class="form-group">
                                <label>Photo de la personne</label>
                                <div class="photo-upload" id="photoUpload">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <p>Cliquez pour télécharger une photo</p>
                                    <input type="file" id="photoInput" accept="image/*" style="display: none;">
                                </div>
                                <div class="photo-preview" id="photoPreview">
                                    <img id="previewImage" src="" alt="Aperçu">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="documents">Documents associés</label>
                                <textarea id="documents" name="documents" placeholder="Actes, lettres, certificats..."></textarea>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3><i class="fas fa-sticky-note"></i> Informations complémentaires</h3>
                            <div class="form-group">
                                <label for="distinctiveSigns">Signes distinctifs</label>
                                <textarea id="distinctiveSigns" name="distinctiveSigns" placeholder="Particularités physiques, traits de caractère..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="testimonies">Témoignages et anecdotes</label>
                                <textarea id="testimonies" name="testimonies" placeholder="Histoires, citations, anecdotes familiales..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="additionalInfo">Informations supplémentaires</label>
                                <textarea id="additionalInfo" name="additionalInfo" placeholder="Croyances, éducation, migrations, biens..."></textarea>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3><i class="fas fa-network-wired"></i> Liens familiaux</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="father">Père</label>
                                    <select id="father" name="father">
                                        <option value="">-- Sélectionner --</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="mother">Mère</label>
                                    <select id="mother" name="mother">
                                        <option value="">-- Sélectionner --</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="spouses">Conjoint(s)</label>
                                <select id="spouses" name="spouses" multiple style="height: 80px;">
                                    <option value="">-- Sélectionner --</option>
                                </select>
                                <small>Maintenez Ctrl (Cmd sur Mac) pour sélectionner plusieurs conjoints</small>
                            </div>
                        </div>

                        <div style="display: flex; gap: 15px; margin-top: 30px;">
                            <button type="submit" class="btn btn-success" style="flex: 1;">
                                <i class="fas fa-save"></i> Enregistrer
                            </button>
                            <button type="button" class="btn btn-primary" id="btnClearForm" style="flex: 1;">
                                <i class="fas fa-broom"></i> Nouveau
                            </button>
                        </div>

                        <input type="hidden" id="personId" name="personId" value="">
                    </form>
                </div>

                <!-- Onglet Arbre -->
                <div class="tab-content" id="treeTab">
                    <h2 style="color: var(--primary); margin-bottom: 20px;">
                        <i class="fas fa-sitemap"></i> Arbre Généalogique
                    </h2>
                    <div style="margin-bottom: 20px;">
                        <button class="btn" id="btnViewFanChart" style="width: auto; display: inline-block; margin-right: 10px;">
                            <i class="fas fa-chart-pie"></i> Vue en éventail
                        </button>
                        <button class="btn" id="btnViewStandardTree" style="width: auto; display: inline-block;">
                            <i class="fas fa-project-diagram"></i> Vue standard
                        </button>
                    </div>
                    <div class="tree-container" id="treeVisualization">
                        <p style="text-align: center; padding: 50px; color: #777;">
                            L'arbre généalogique s'affichera ici. Ajoutez d'abord quelques personnes.
                        </p>
                    </div>
                </div>

                <!-- Onglet Liste -->
                <div class="tab-content" id="listTab">
                    <h2 style="color: var(--primary); margin-bottom: 20px;">
                        <i class="fas fa-list"></i> Liste des personnes
                    </h2>
                    <div style="margin-bottom: 20px;">
                        <input type="text" id="searchPerson" placeholder="Rechercher une personne..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
                    </div>
                    <div class="person-list" id="personListContainer">
                        <!-- Liste remplie dynamiquement -->
                    </div>
                </div>

                <!-- Onglet Statistiques -->
                <div class="tab-content" id="statsTab">
                    <h2 style="color: var(--primary); margin-bottom: 20px;">
                        <i class="fas fa-chart-bar"></i> Statistiques de l'arbre
                    </h2>
                    <div class="stats-grid" id="statsGrid">
                        <!-- Rempli dynamiquement -->
                    </div>
                    <div style="margin-top: 30px;">
                        <h3 style="color: var(--primary); margin-bottom: 15px;">
                            <i class="fas fa-map-marker-alt"></i> Répartition géographique
                        </h3>
                        <div id="mapPlaceholder" style="background-color: #f8fafc; padding: 30px; border-radius: 10px; text-align: center; color: #777;">
                            <i class="fas fa-map" style="font-size: 3rem; margin-bottom: 15px;"></i>
                            <p>Carte des lieux de naissance et de décès (à implémenter)</p>
                        </div>
                    </div>
                </div>

                <!-- Onglet Chronologie -->
                <div class="tab-content" id="timelineTab">
                    <h2 style="color: var(--primary); margin-bottom: 20px;">
                        <i class="fas fa-stream"></i> Chronologie familiale
                    </h2>
                    <div class="timeline" id="timelineContainer">
                        <!-- Rempli dynamiquement -->
                    </div>
                </div>

                <!-- Onglet Export/Import -->
                <div class="tab-content" id="exportTab">
                    <h2 style="color: var(--primary); margin-bottom: 20px;">
                        <i class="fas fa-exchange-alt"></i> Export et Import de données
                    </h2>
                    <div class="export-options">
                        <div class="export-card" id="exportJSON">
                            <i class="fas fa-file-code"></i>
                            <h3>Exporter en JSON</h3>
                            <p>Téléchargez vos données au format JSON pour sauvegarde</p>
                        </div>
                        <div class="export-card" id="exportGEDCOM">
                            <i class="fas fa-file-alt"></i>
                            <h3>Exporter en GEDCOM</h3>
                            <p>Format standard pour échanger avec d'autres logiciels</p>
                        </div>
                        <div class="export-card" id="exportPDF">
                            <i class="fas fa-file-pdf"></i>
                            <h3>Exporter en PDF</h3>
                            <p>Créez un document imprimable de votre arbre</p>
                        </div>
                        <div class="export-card" id="importData">
                            <i class="fas fa-file-import"></i>
                            <h3>Importer des données</h3>
                            <p>Importez un fichier JSON ou GEDCOM</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 40px; background-color: #f8fafc; padding: 20px; border-radius: 10px;">
                        <h3 style="color: var(--primary); margin-bottom: 15px;">
                            <i class="fas fa-database"></i> Sauvegarde automatique
                        </h3>
                        <p>Vos données sont automatiquement sauvegardées dans votre navigateur.</p>
                        <p style="margin-top: 10px; font-size: 0.9rem; color: #777;">
                            <i class="fas fa-info-circle"></i> Pour une sauvegarde permanente, exportez régulièrement vos données.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>Mon Arbre Généalogique &copy; 2026 - Application pour reconstruire mon histoire familiale sur 15 générations</p>
            <p style="font-size: 0.9rem; margin-top: 10px;">Théoriquement, un arbre sur 15 générations contient 32 767 personnes (moi + 16 384 ancêtres à la 15ème génération + leurs conjoints)</p>
        </footer>
    </div>

    <!-- Modal pour visualiser une personne -->
    <div class="modal" id="personModal">
        <div class="modal-content">
            <span class="close-modal" id="closeModal">&times;</span>
            <div id="modalContent">
                <!-- Contenu rempli dynamiquement -->
            </div>
        </div>
    </div>

     <div class="loading" id="loading">
        <div class="spinner"></div>
        <p id="loadingText">Chargement...</p>
    </div>
    
 <script>
        // ==============================================
        // CONFIGURATION ET CONSTANTES
        // ==============================================
        const CONFIG = {
            MAX_GENERATIONS: 15,
            MAX_PERSONS_WARNING: 500,
            AUTO_SAVE_INTERVAL: 30000, // 30 secondes
            BACKUP_DAYS: 7,
            VIRTUAL_LIST_ITEM_HEIGHT: 80,
            PERFORMANCE_THRESHOLD: 1000
        };
        
        // ==============================================
        // MODULE DE GESTION DES DONNÉES
        // ==============================================
        const DataManager = {
            familyTree: {
                persons: [],
                nextId: 1,
                metadata: {
                    created: new Date().toISOString(),
                    lastModified: new Date().toISOString(),
                    version: "2.0.0",
                    totalGenerations: CONFIG.MAX_GENERATIONS
                }
            },
            
            cache: {
                stats: null,
                generationMap: null,
                lastUpdate: 0
            },
            
            // Initialiser les données
            init() {
                this.loadData();
                this.rebuildCache();
                return this.familyTree;
            },
            
            // Sauvegarder les données
            save() {
                try {
                    this.familyTree.metadata.lastModified = new Date().toISOString();
                    this.familyTree.metadata.personCount = this.familyTree.persons.length;
                    this.familyTree.metadata.stats = this.calculateStats();
                    
                    const dataStr = JSON.stringify(this.familyTree);
                    localStorage.setItem('familyTreeData', dataStr);
                    
                    this.rebuildCache();
                    return true;
                } catch (error) {
                    console.error('Erreur sauvegarde:', error);
                    return false;
                }
            },
            
            // Charger depuis localStorage
            loadData() {
                try {
                    const savedData = localStorage.getItem('familyTreeData');
                    if (savedData) {
                        this.familyTree = JSON.parse(savedData);
                        
                        // Migration de données si nécessaire
                        this.migrateData();
                        
                        // Assurer l'intégrité des données
                        this.ensureDataIntegrity();
                        
                        if (!this.familyTree.nextId || this.familyTree.nextId <= this.familyTree.persons.length) {
                            this.familyTree.nextId = this.familyTree.persons.length + 1;
                        }
                        
                        console.log(`Données chargées: ${this.familyTree.persons.length} personnes`);
                    } else {
                        this.addSampleData();
                    }
                } catch (error) {
                    console.error('Erreur chargement:', error);
                    this.addSampleData();
                }
            },
            
            // Migration de données
            migrateData() {
                // Ajouter des champs manquants si nécessaire
                this.familyTree.persons.forEach(person => {
                    if (!person.id) person.id = this.generateId();
                    if (!person.generation) person.generation = this.calculateGeneration(person);
                });
            },
            
            // Assurer l'intégrité des données
            ensureDataIntegrity() {
                const validIds = new Set();
                
                // Filtrer les personnes sans ID
                this.familyTree.persons = this.familyTree.persons.filter(person => {
                    if (!person.id) return false;
                    if (validIds.has(person.id)) return false; // Éviter les doublons
                    validIds.add(person.id);
                    return true;
                });
                
                // Nettoyer les références invalides
                this.familyTree.persons.forEach(person => {
                    if (person.father && !validIds.has(person.father)) person.father = '';
                    if (person.mother && !validIds.has(person.mother)) person.mother = '';
                    if (person.spouses) {
                        person.spouses = person.spouses.filter(id => validIds.has(id));
                    }
                });
            },
            
            // Reconstruire le cache
            rebuildCache() {
                this.cache.stats = this.calculateStats();
                this.cache.generationMap = this.buildGenerationMap();
                this.cache.lastUpdate = Date.now();
            },
            
            // Obtenir les statistiques (avec cache)
            getStats() {
                if (!this.cache.stats || Date.now() - this.cache.lastUpdate > 5000) {
                    this.cache.stats = this.calculateStats();
                    this.cache.lastUpdate = Date.now();
                }
                return this.cache.stats;
            },
            
            // Calculer les statistiques
            calculateStats() {
                const persons = this.familyTree.persons;
                const total = persons.length;
                
                if (total === 0) {
                    return {
                        totalPersons: 0,
                        maleCount: 0,
                        femaleCount: 0,
                        unknownGender: 0,
                        malePercent: 0,
                        femalePercent: 0,
                        withPhoto: 0,
                        withPhotoPercent: 0,
                        averageAge: 0,
                        uniqueLocations: 0,
                        marriedCount: 0,
                        maxGeneration: 1,
                        completeness: 0
                    };
                }
                
                const maleCount = persons.filter(p => p.gender === 'M').length;
                const femaleCount = persons.filter(p => p.gender === 'F').length;
                const withPhoto = persons.filter(p => p.photo && p.photo.length > 0).length;
                
                // Âge moyen
                let totalAge = 0;
                let countWithAge = 0;
                
                persons.forEach(person => {
                    if (person.birthDate && person.deathDate) {
                        const birth = new Date(person.birthDate);
                        const death = new Date(person.deathDate);
                        const age = death.getFullYear() - birth.getFullYear();
                        if (age > 0 && age < 120) {
                            totalAge += age;
                            countWithAge++;
                        }
                    }
                });
                
                // Lieux uniques
                const locations = new Set();
                persons.forEach(person => {
                    if (person.birthPlace) locations.add(person.birthPlace);
                    if (person.deathPlace) locations.add(person.deathPlace);
                });
                
                // Personnes mariées
                const marriedCount = persons.filter(p => p.spouses && p.spouses.length > 0).length;
                
                // Génération max
                const maxGeneration = Math.max(...persons.map(p => p.generation || 1));
                
                // Complétude théorique
                let theoreticalCount = 0;
                for (let i = 1; i <= Math.min(maxGeneration, CONFIG.MAX_GENERATIONS); i++) {
                    const theoretical = i === 1 ? 1 : Math.pow(2, i - 1);
                    const actual = persons.filter(p => p.generation === i).length;
                    theoreticalCount += Math.min(actual, theoretical);
                }
                
                const totalTheoretical = Math.pow(2, CONFIG.MAX_GENERATIONS) - 1;
                const completeness = totalTheoretical > 0 ? Math.round((theoreticalCount / totalTheoretical) * 100) : 0;
                
                return {
                    totalPersons: total,
                    maleCount,
                    femaleCount,
                    unknownGender: total - maleCount - femaleCount,
                    malePercent: Math.round((maleCount / total) * 100),
                    femalePercent: Math.round((femaleCount / total) * 100),
                    withPhoto,
                    withPhotoPercent: Math.round((withPhoto / total) * 100),
                    averageAge: countWithAge > 0 ? Math.round(totalAge / countWithAge) : 0,
                    uniqueLocations: locations.size,
                    marriedCount,
                    maxGeneration,
                    completeness
                };
            },
            
            // Construire la carte des générations
            buildGenerationMap() {
                const map = new Map();
                for (let i = 1; i <= CONFIG.MAX_GENERATIONS; i++) {
                    map.set(i, this.familyTree.persons.filter(p => p.generation === i));
                }
                return map;
            },
            
            // Générer un ID unique
            generateId() {
                return 'P-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            },
            
            // Ajouter une personne
            addPerson(personData) {
                if (!personData.id) {
                    personData.id = this.generateId();
                }
                
                if (!personData.generation) {
                    personData.generation = this.calculateGeneration(personData);
                }
                
                this.familyTree.persons.push(personData);
                this.save();
                return personData;
            },
            
            // Mettre à jour une personne
            updatePerson(personId, updates) {
                const index = this.familyTree.persons.findIndex(p => p.id === personId);
                if (index !== -1) {
                    // Mettre à jour la génération si les parents changent
                    if (updates.father || updates.mother) {
                        updates.generation = this.calculateGeneration({
                            ...this.familyTree.persons[index],
                            ...updates
                        });
                    }
                    
                    this.familyTree.persons[index] = {
                        ...this.familyTree.persons[index],
                        ...updates
                    };
                    
                    this.save();
                    return this.familyTree.persons[index];
                }
                return null;
            },
            
            // Calculer la génération
            calculateGeneration(person) {
                if (person.generation) return person.generation;
                
                let maxParentGen = 1;
                
                if (person.father) {
                    const father = this.familyTree.persons.find(p => p.id === person.father);
                    if (father && father.generation) {
                        maxParentGen = Math.max(maxParentGen, father.generation + 1);
                    }
                }
                
                if (person.mother) {
                    const mother = this.familyTree.persons.find(p => p.id === person.mother);
                    if (mother && mother.generation) {
                        maxParentGen = Math.max(maxParentGen, mother.generation + 1);
                    }
                }
                
                return Math.min(maxParentGen, CONFIG.MAX_GENERATIONS);
            },
            
            // Trouver une personne
            findPerson(personId) {
                return this.familyTree.persons.find(p => p.id === personId);
            },
            
            // Rechercher des personnes
            searchPersons(query, limit = 50) {
                if (!query) return this.familyTree.persons.slice(0, limit);
                
                const q = query.toLowerCase();
                return this.familyTree.persons.filter(person => {
                    const fullName = `${person.firstName || ''} ${person.lastName || ''} ${person.nickname || ''}`.toLowerCase();
                    return fullName.includes(q) ||
                           (person.birthPlace && person.birthPlace.toLowerCase().includes(q)) ||
                           (person.professions && person.professions.toLowerCase().includes(q));
                }).slice(0, limit);
            },
            
            // Données d'exemple
            addSampleData() {
                this.familyTree.persons = [
                    {
                        id: "P-1",
                        lastName: "Dupont",
                        firstName: "Jean",
                        nickname: "Le Grand",
                        gender: "M",
                        birthDate: "1890-03-15",
                        birthPlace: "Paris, France",
                        deathDate: "1965-06-22",
                        deathPlace: "Lyon, France",
                        professions: "Menuisier (1910-1940), puis commerçant (1940-1955)",
                        residences: "Paris (1890-1920), Lyon (1920-1965)",
                        photo: "",
                        documents: "Acte de naissance, carte d'identité 1932",
                        distinctiveSigns: "Cicatrice au menton, voix grave",
                        testimonies: "Témoignage de sa fille Marie: 'Mon père était un homme travailleur qui a reconstruit son commerce après la guerre.'",
                        additionalInfo: "A participé à la Première Guerre mondiale, a été fait prisonnier en 1916.",
                        father: "",
                        mother: "",
                        spouses: ["P-2"],
                        generation: 3
                    },
                    {
                        id: "P-2",
                        lastName: "Martin",
                        firstName: "Marie",
                        nickname: "",
                        gender: "F",
                        birthDate: "1895-11-08",
                        birthPlace: "Lyon, France",
                        deathDate: "1972-04-30",
                        deathPlace: "Lyon, France",
                        professions: "Ménagère, aide dans le commerce familial",
                        residences: "Lyon (1915-1972)",
                        photo: "",
                        documents: "",
                        distinctiveSigns: "Yeux bleus, toujours souriante",
                        testimonies: "S'occupait de la comptabilité du commerce de son mari.",
                        additionalInfo: "A élevé 4 enfants. Aimait jardiner.",
                        father: "",
                        mother: "",
                        spouses: ["P-1"],
                        generation: 3
                    },
                    {
                        id: "P-3",
                        lastName: "Dupont",
                        firstName: "Pierre",
                        nickname: "",
                        gender: "M",
                        birthDate: "1920-08-12",
                        birthPlace: "Paris, France",
                        deathDate: "2005-03-18",
                        deathPlace: "Marseille, France",
                        professions: "Ingénieur, professeur à l'université",
                        residences: "Paris (1920-1945), Marseille (1945-2005)",
                        photo: "",
                        documents: "Diplôme d'ingénieur, médaille de la Résistance",
                        distinctiveSigns: "Portait toujours des lunettes",
                        testimonies: "A participé à la Résistance pendant la Seconde Guerre mondiale.",
                        additionalInfo: "A publié plusieurs articles scientifiques.",
                        father: "P-1",
                        mother: "P-2",
                        spouses: [],
                        generation: 2
                    },
                    {
                        id: "P-4",
                        lastName: "Dupont",
                        firstName: "Sophie",
                        nickname: "",
                        gender: "F",
                        birthDate: "1985-05-20",
                        birthPlace: "Marseille, France",
                        deathDate: "",
                        deathPlace: "",
                        professions: "Médecin généraliste",
                        residences: "Marseille (1985-2010), Paris (2010-aujourd'hui)",
                        photo: "",
                        documents: "",
                        distinctiveSigns: "",
                        testimonies: "",
                        additionalInfo: "",
                        father: "P-3",
                        mother: "",
                        spouses: [],
                        generation: 1
                    }
                ];
                
                this.familyTree.nextId = 5;
                this.save();
            }
        };
        
        // ==============================================
        // MODULE D'INTERFACE UTILISATEUR
        // ==============================================
        const UIManager = {
            // Éléments DOM
            elements: {},
            
            // État de l'interface
            state: {
                currentTab: 'form',
                selectedPersonId: null,
                searchQuery: '',
                virtualList: {
                    startIndex: 0,
                    visibleItems: 10,
                    totalHeight: 0
                }
            },
            
            // Initialiser l'interface
            init() {
                this.cacheElements();
                this.setupEventListeners();
                this.updateAll();
                this.showTutorial();
                this.createStatusBar();
                
                // Vérifier les performances
                this.checkPerformance();
            },
            
            // Mettre en cache les éléments DOM
            cacheElements() {
                this.elements = {
                    tabs: document.querySelectorAll('.tab'),
                    tabContents: document.querySelectorAll('.tab-content'),
                    personForm: document.getElementById('personForm'),
                    photoUpload: document.getElementById('photoUpload'),
                    photoInput: document.getElementById('photoInput'),
                    photoPreview: document.getElementById('photoPreview'),
                    previewImage: document.getElementById('previewImage'),
                    progressFill: document.getElementById('progressFill'),
                    progressText: document.getElementById('progressText'),
                    personCountList: document.getElementById('personCountList'),
                    personListContainer: document.getElementById('personListContainer'),
                    searchPerson: document.getElementById('searchPerson'),
                    statsGrid: document.getElementById('statsGrid'),
                    timelineContainer: document.getElementById('timelineContainer'),
                    btnClearForm: document.getElementById('btnClearForm'),
                    personModal: document.getElementById('personModal'),
                    closeModal: document.getElementById('closeModal'),
                    modalContent: document.getElementById('modalContent'),
                    loading: document.getElementById('loading'),
                    loadingText: document.getElementById('loadingText')
                };
            },
            
            // Configurer les événements
            setupEventListeners() {
                // Onglets
                this.elements.tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabId = tab.getAttribute('data-tab');
                        this.switchTab(tabId);
                    });
                });
                
                // Navigation
                this.setupButton('btnNewPerson', () => {
                    this.clearForm();
                    this.switchTab('form');
                });
                
                this.setupButton('btnViewTree', () => {
                    this.switchTab('tree');
                    TreeVisualizer.renderTree();
                });
                
                this.setupButton('btnViewList', () => {
                    this.switchTab('list');
                    this.renderPersonList();
                });
                
                this.setupButton('btnStats', () => {
                    this.switchTab('stats');
                    this.renderStats();
                });
                
                this.setupButton('btnTimeline', () => {
                    this.switchTab('timeline');
                    this.renderTimeline();
                });
                
                this.setupButton('btnExport', () => {
                    this.switchTab('export');
                });
                
                this.setupButton('btnImport', () => {
                    this.triggerFileImport();
                });
                
                // Photo upload
                this.elements.photoUpload.addEventListener('click', () => {
                    this.elements.photoInput.click();
                });
                
                this.elements.photoInput.addEventListener('change', (e) => {
                    this.handlePhotoUpload(e);
                });
                
                // Formulaire
                this.elements.personForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.savePerson();
                });
                
                this.elements.btnClearForm.addEventListener('click', () => {
                    this.clearForm();
                });
                
                // Recherche avec debounce
                let searchTimeout;
                this.elements.searchPerson?.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        this.state.searchQuery = e.target.value;
                        this.renderPersonList();
                    }, 300);
                });
                
                // Export/Import
                this.setupButton('exportJSON', ExportManager.exportJSON);
                this.setupButton('exportGEDCOM', ExportManager.exportGEDCOM);
                this.setupButton('exportPDF', ExportManager.exportPDF);
                this.setupButton('importData', () => this.triggerFileImport());
                
                // Modal
                this.elements.closeModal.addEventListener('click', () => {
                    this.hideModal();
                });
                
                window.addEventListener('click', (event) => {
                    if (event.target === this.elements.personModal) {
                        this.hideModal();
                    }
                });
                
                // Arbre interactif
                this.setupButton('btnInteractiveTree', () => {
                    this.switchTab('tree');
                    TreeVisualizer.renderInteractiveTree();
                });
                
                this.setupButton('btnLineageChart', () => {
                    this.switchTab('tree');
                    LineageAnalyzer.renderLineageChart();
                });
            },
            
            // Helper pour configurer les boutons
            setupButton(id, handler) {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('click', handler);
                }
            },
            
            // Changer d'onglet
            switchTab(tabId) {
                this.state.currentTab = tabId;
                
                // Désactiver tous les onglets
                this.elements.tabs.forEach(tab => tab.classList.remove('active'));
                this.elements.tabContents.forEach(content => content.classList.remove('active'));
                
                // Activer l'onglet sélectionné
                const activeTab = document.querySelector(`.tab[data-tab="${tabId}"]`);
                const activeContent = document.getElementById(`${tabId}Tab`);
                
                if (activeTab) activeTab.classList.add('active');
                if (activeContent) activeContent.classList.add('active');
            },
            
            // Afficher le chargement
            showLoading(text = 'Chargement...') {
                this.elements.loadingText.textContent = text;
                this.elements.loading.classList.add('active');
            },
            
            // Cacher le chargement
            hideLoading() {
                this.elements.loading.classList.remove('active');
            },
            
            // Gérer l'upload de photo
            handlePhotoUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) { // 5MB max
                        alert('La photo ne doit pas dépasser 5MB');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.elements.previewImage.src = e.target.result;
                        this.elements.photoPreview.style.display = 'block';
                        
                        // Compresser l'image pour le stockage
                        this.compressImage(e.target.result, (compressed) => {
                            this.elements.previewImage.src = compressed;
                        });
                    };
                    reader.readAsDataURL(file);
                }
            },
            
            // Compresser l'image
            compressImage(dataUrl, callback) {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Définir la taille max
                    const maxWidth = 800;
                    const maxHeight = 800;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) {
                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width = Math.round((width * maxHeight) / height);
                            height = maxHeight;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    callback(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.src = dataUrl;
            },
            
            // Sauvegarder une personne
            async savePerson() {
                this.showLoading('Sauvegarde en cours...');
                
                try {
                    const personId = document.getElementById('personId').value;
                    const personData = this.collectFormData();
                    
                    let result;
                    if (personId) {
                        result = DataManager.updatePerson(personId, personData);
                    } else {
                        result = DataManager.addPerson(personData);
                    }
                    
                    if (result) {
                        this.updatePersonSelects();
                        this.updateAll();
                        this.clearForm();
                        this.showNotification(`Personne ${personId ? 'modifiée' : 'ajoutée'} avec succès !`, 'success');
                    }
                } catch (error) {
                    console.error('Erreur sauvegarde:', error);
                    this.showNotification('Erreur lors de la sauvegarde', 'error');
                } finally {
                    this.hideLoading();
                }
            },
            
            // Collecter les données du formulaire
            collectFormData() {
                return {
                    lastName: document.getElementById('lastName').value,
                    firstName: document.getElementById('firstName').value,
                    nickname: document.getElementById('nickname').value,
                    gender: document.getElementById('gender').value,
                    birthDate: document.getElementById('birthDate').value,
                    birthPlace: document.getElementById('birthPlace').value,
                    deathDate: document.getElementById('deathDate').value,
                    deathPlace: document.getElementById('deathPlace').value,
                    professions: document.getElementById('professions').value,
                    residences: document.getElementById('residences').value,
                    photo: this.elements.previewImage.src || '',
                    documents: document.getElementById('documents').value,
                    distinctiveSigns: document.getElementById('distinctiveSigns').value,
                    testimonies: document.getElementById('testimonies').value,
                    additionalInfo: document.getElementById('additionalInfo').value,
                    father: document.getElementById('father').value,
                    mother: document.getElementById('mother').value,
                    spouses: Array.from(document.getElementById('spouses').selectedOptions)
                        .map(opt => opt.value)
                        .filter(v => v)
                };
            },
            
            // Effacer le formulaire
            clearForm() {
                this.elements.personForm.reset();
                document.getElementById('personId').value = '';
                this.elements.photoPreview.style.display = 'none';
                this.elements.previewImage.src = '';
            },
            
            // Mettre à jour les sélecteurs
            updatePersonSelects() {
                const selects = ['father', 'mother', 'spouses'];
                const selectedValues = {};
                
                // Sauvegarder les valeurs sélectionnées
                selects.forEach(id => {
                    const select = document.getElementById(id);
                    if (select) {
                        if (select.multiple) {
                            selectedValues[id] = Array.from(select.selectedOptions).map(opt => opt.value);
                        } else {
                            selectedValues[id] = select.value;
                        }
                    }
                });
                
                // Regénérer les options
                selects.forEach(id => {
                    const select = document.getElementById(id);
                    if (select) {
                        select.innerHTML = '<option value="">-- Sélectionner --</option>';
                        
                        DataManager.familyTree.persons.forEach(person => {
                            const option = document.createElement('option');
                            option.value = person.id;
                            option.textContent = `${person.firstName} ${person.lastName} (G${person.generation || '?'})`;
                            
                            // Filtres selon le type de sélecteur
                            if (id === 'father' && person.gender !== 'M' && person.gender !== 'U') return;
                            if (id === 'mother' && person.gender !== 'F' && person.gender !== 'U') return;
                            
                            select.appendChild(option);
                        });
                        
                        // Restaurer les sélections
                        if (select.multiple && selectedValues[id]) {
                            selectedValues[id].forEach(value => {
                                const option = Array.from(select.options).find(opt => opt.value === value);
                                if (option) option.selected = true;
                            });
                        } else if (selectedValues[id]) {
                            select.value = selectedValues[id];
                        }
                    }
                });
            },
            
            // Mettre à jour toute l'interface
            updateAll() {
                this.updateProgress();
                this.updatePersonCount();
                
                // Mettre à jour l'onglet actif
                switch (this.state.currentTab) {
                    case 'list':
                        this.renderPersonList();
                        break;
                    case 'stats':
                        this.renderStats();
                        break;
                    case 'timeline':
                        this.renderTimeline();
                        break;
                    case 'tree':
                        TreeVisualizer.renderTree();
                        break;
                }
            },
            
            // Mettre à jour la progression
            updateProgress() {
                const stats = DataManager.getStats();
                const progress = Math.min((stats.totalPersons / 100) * 100, 100);
                
                if (this.elements.progressFill) {
                    this.elements.progressFill.style.width = `${progress}%`;
                }
                
                if (this.elements.progressText) {
                    this.elements.progressText.textContent = `${stats.totalPersons} personnes (${stats.completeness}% complété)`;
                }
            },
            
            // Mettre à jour le compteur
            updatePersonCount() {
                const stats = DataManager.getStats();
                
                if (this.elements.personCountList) {
                    this.elements.personCountList.innerHTML = `
                        <li><strong>Total:</strong> ${stats.totalPersons} personnes</li>
                        <li><strong>Hommes:</strong> ${stats.maleCount}</li>
                        <li><strong>Femmes:</strong> ${stats.femaleCount}</li>
                        <li><strong>Genre inconnu:</strong> ${stats.unknownGender}</li>
                        <li><strong>Avec photo:</strong> ${stats.withPhoto}</li>
                        <li><strong>Génération max:</strong> ${stats.maxGeneration}</li>
                    `;
                }
            },
            
            // Rendre la liste des personnes (avec virtualisation si nécessaire)
            renderPersonList() {
                const container = this.elements.personListContainer;
                if (!container) return;
                
                const persons = DataManager.searchPersons(this.state.searchQuery);
                const total = persons.length;
                
                if (total === 0) {
                    container.innerHTML = `
                        <p style="text-align: center; padding: 40px; color: #777;">
                            ${this.state.searchQuery ? 'Aucune personne ne correspond à votre recherche.' : 'Aucune personne dans l\'arbre.'}
                        </p>
                    `;
                    return;
                }
                
                // Utiliser la virtualisation pour les grandes listes
                if (total > CONFIG.PERFORMANCE_THRESHOLD) {
                    this.renderVirtualList(persons, container);
                } else {
                    this.renderFullList(persons, container);
                }
            },
            
            // Rendre la liste complète
            renderFullList(persons, container) {
                container.innerHTML = persons.map(person => this.createPersonListItem(person)).join('');
                this.attachListEvents(container);
            },
            
            // Rendre la liste virtualisée
            renderVirtualList(persons, container) {
                const itemHeight = CONFIG.VIRTUAL_LIST_ITEM_HEIGHT;
                const totalHeight = persons.length * itemHeight;
                
                container.innerHTML = `
                    <div class="virtual-list" style="height: ${totalHeight}px;">
                        ${persons.slice(this.state.virtualList.startIndex, 
                            this.state.virtualList.startIndex + this.state.virtualList.visibleItems)
                            .map((person, index) => `
                                <div class="virtual-list-item" 
                                     style="top: ${(this.state.virtualList.startIndex + index) * itemHeight}px;"
                                     data-id="${person.id}">
                                    ${this.createPersonListItem(person)}
                                </div>
                            `).join('')}
                    </div>
                `;
                
                // Gérer le scroll pour la virtualisation
                const listContainer = container.querySelector('.virtual-list');
                listContainer.addEventListener('scroll', () => {
                    const scrollTop = listContainer.scrollTop;
                    const startIndex = Math.floor(scrollTop / itemHeight);
                    const endIndex = Math.min(startIndex + this.state.virtualList.visibleItems, persons.length);
                    
                    if (startIndex !== this.state.virtualList.startIndex) {
                        this.state.virtualList.startIndex = startIndex;
                        this.renderVirtualList(persons, container);
                    }
                });
                
                this.attachListEvents(container);
            },
            
            // Créer un élément de liste
            createPersonListItem(person) {
                const birthYear = person.birthDate ? new Date(person.birthDate).getFullYear() : '?';
                const deathYear = person.deathDate ? new Date(person.deathDate).getFullYear() : '?';
                
                return `
                    <div class="person-list-item" data-id="${person.id}">
                        ${person.photo ? 
                            `<img src="${person.photo}" class="person-list-photo" alt="${person.firstName} ${person.lastName}">` : 
                            `<div class="person-list-photo" style="background-color: ${person.gender === 'M' ? '#3498db' : person.gender === 'F' ? '#e74c3c' : '#95a5a6'};">
                                <i class="fas fa-user"></i>
                            </div>`
                        }
                        <div class="person-list-info">
                            <h4>${person.firstName} ${person.lastName} ${person.nickname ? `"${person.nickname}"` : ''}</h4>
                            <p>${birthYear} - ${deathYear} | ${person.birthPlace || 'Lieu inconnu'}</p>
                            <p>${person.professions ? person.professions.substring(0, 50) + (person.professions.length > 50 ? '...' : '') : ''}</p>
                        </div>
                        <div class="list-actions">
                            <button class="btn btn-sm" onclick="UIManager.editPerson('${person.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-view" onclick="UIManager.viewPersonDetails('${person.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                `;
            },
            
            // Attacher les événements à la liste
            attachListEvents(container) {
                container.querySelectorAll('.person-list-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        if (!e.target.closest('button')) {
                            const personId = item.getAttribute('data-id');
                            this.viewPersonDetails(personId);
                        }
                    });
                });
            },
            
            // Rendre les statistiques
            renderStats() {
                const stats = DataManager.getStats();
                
                if (!this.elements.statsGrid) return;
                
                this.elements.statsGrid.innerHTML = `
                    <div class="stat-card">
                        <i class="fas fa-users"></i>
                        <div class="stat-number">${stats.totalPersons}</div>
                        <div class="stat-label">Personnes totales</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-venus"></i>
                        <div class="stat-number">${stats.femaleCount}</div>
                        <div class="stat-label">Femmes (${stats.femalePercent}%)</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-mars"></i>
                        <div class="stat-number">${stats.maleCount}</div>
                        <div class="stat-label">Hommes (${stats.malePercent}%)</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-camera"></i>
                        <div class="stat-number">${stats.withPhoto}</div>
                        <div class="stat-label">Avec photo (${stats.withPhotoPercent}%)</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-birthday-cake"></i>
                        <div class="stat-number">${stats.averageAge}</div>
                        <div class="stat-label">Âge moyen (ans)</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-map-marked-alt"></i>
                        <div class="stat-number">${stats.uniqueLocations}</div>
                        <div class="stat-label">Lieux différents</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-heart"></i>
                        <div class="stat-number">${stats.marriedCount}</div>
                        <div class="stat-label">Personnes mariées</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-layer-group"></i>
                        <div class="stat-number">${stats.maxGeneration}/15</div>
                        <div class="stat-label">Génération max</div>
                    </div>
                `;
            },
            
            // Rendre la chronologie
            renderTimeline() {
                const persons = DataManager.familyTree.persons
                    .filter(p => p.birthDate)
                    .sort((a, b) => new Date(a.birthDate) - new Date(b.birthDate))
                    .slice(0, 20);
                
                if (!this.elements.timelineContainer) return;
                
                if (persons.length === 0) {
                    this.elements.timelineContainer.innerHTML = `
                        <div style="text-align: center; padding: 50px; color: #777;">
                            <i class="fas fa-stream" style="font-size: 3rem;"></i>
                            <p>Ajoutez des personnes avec des dates pour voir la chronologie.</p>
                        </div>
                    `;
                    return;
                }
                
                this.elements.timelineContainer.innerHTML = persons.map((person, index) => {
                    const birthYear = new Date(person.birthDate).getFullYear();
                    const deathYear = person.deathDate ? new Date(person.deathDate).getFullYear() : '?';
                    
                    return `
                        <div class="timeline-item ${index % 2 === 0 ? 'left' : 'right'}">
                            <div class="timeline-content">
                                <h4>${person.firstName} ${person.lastName}</h4>
                                <p><strong>${birthYear} - ${deathYear}</strong></p>
                                <p>${person.birthPlace || ''}</p>
                                <p>${person.professions ? person.professions.substring(0, 80) + '...' : ''}</p>
                                <button class="btn btn-sm" onclick="UIManager.viewPersonDetails('${person.id}')">
                                    Voir détails
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            },
            
            // Voir les détails d'une personne
            viewPersonDetails(personId) {
                const person = DataManager.findPerson(personId);
                if (!person) return;
                
                const father = person.father ? DataManager.findPerson(person.father) : null;
                const mother = person.mother ? DataManager.findPerson(person.mother) : null;
                const spouses = person.spouses ? person.spouses.map(id => DataManager.findPerson(id)).filter(p => p) : [];
                
                const birthYear = person.birthDate ? new Date(person.birthDate).getFullYear() : 'Inconnue';
                const deathYear = person.deathDate ? new Date(person.deathDate).getFullYear() : 'Inconnue';
                
                this.elements.modalContent.innerHTML = `
                    <div class="modal-header">
                        <h2>${person.firstName} ${person.lastName}</h2>
                        ${person.nickname ? `<p class="nickname">"${person.nickname}"</p>` : ''}
                    </div>
                    
                    <div class="modal-body">
                        <div class="person-basic-info">
                            ${person.photo ? `<img src="${person.photo}" class="modal-photo" alt="${person.firstName} ${person.lastName}">` : ''}
                            <div class="person-details">
                                <p><strong>${birthYear} - ${deathYear}</strong></p>
                                <p>${person.birthPlace ? `Né(e) à ${person.birthPlace}` : ''}</p>
                                <p>${person.deathPlace ? `Décédé(e) à ${person.deathPlace}` : ''}</p>
                                <p>${person.gender === 'M' ? 'Homme' : person.gender === 'F' ? 'Femme' : 'Genre non spécifié'}</p>
                                <p>Génération: ${person.generation || 'Non calculée'}</p>
                            </div>
                        </div>
                        
                        ${this.createInfoSection('Profession(s)', person.professions, 'briefcase')}
                        ${this.createInfoSection('Résidences', person.residences, 'home')}
                        ${this.createInfoSection('Signes distinctifs', person.distinctiveSigns, 'user-tag')}
                        ${this.createInfoSection('Témoignages', person.testimonies, 'comment')}
                        ${this.createInfoSection('Informations supplémentaires', person.additionalInfo, 'info-circle')}
                        
                        <div class="family-links">
                            <h4><i class="fas fa-network-wired"></i> Liens familiaux</h4>
                            <div class="links-container">
                                ${father ? this.createFamilyLink('Père', father) : ''}
                                ${mother ? this.createFamilyLink('Mère', mother) : ''}
                                ${spouses.length > 0 ? `
                                    <div class="family-link">
                                        <strong>Conjoint(s):</strong>
                                        ${spouses.map(spouse => this.createFamilyLink('', spouse)).join(', ')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button class="btn btn-primary" onclick="UIManager.editPerson('${person.id}')">
                            <i class="fas fa-edit"></i> Modifier
                        </button>
                        <button class="btn" onclick="UIManager.hideModal()">
                            <i class="fas fa-times"></i> Fermer
                        </button>
                    </div>
                `;
                
                this.showModal();
            },
            
            // Créer une section d'information
            createInfoSection(title, content, icon) {
                if (!content) return '';
                return `
                    <div class="info-section">
                        <h4><i class="fas fa-${icon}"></i> ${title}</h4>
                        <p>${content}</p>
                    </div>
                `;
            },
            
            // Créer un lien familial
            createFamilyLink(label, person) {
                return `
                    <div class="family-link">
                        ${label ? `<strong>${label}:</strong>` : ''}
                        ${person.firstName} ${person.lastName}
                        <button class="btn btn-sm" onclick="UIManager.viewPersonDetails('${person.id}')">
                            Voir
                        </button>
                    </div>
                `;
            },
            
            // Modifier une personne
            editPerson(personId) {
                const person = DataManager.findPerson(personId);
                if (!person) return;
                
                // Remplir le formulaire
                document.getElementById('personId').value = person.id;
                document.getElementById('lastName').value = person.lastName || '';
                document.getElementById('firstName').value = person.firstName || '';
                document.getElementById('nickname').value = person.nickname || '';
                document.getElementById('gender').value = person.gender || 'U';
                document.getElementById('birthDate').value = person.birthDate || '';
                document.getElementById('birthPlace').value = person.birthPlace || '';
                document.getElementById('deathDate').value = person.deathDate || '';
                document.getElementById('deathPlace').value = person.deathPlace || '';
                document.getElementById('professions').value = person.professions || '';
                document.getElementById('residences').value = person.residences || '';
                document.getElementById('documents').value = person.documents || '';
                document.getElementById('distinctiveSigns').value = person.distinctiveSigns || '';
                document.getElementById('testimonies').value = person.testimonies || '';
                document.getElementById('additionalInfo').value = person.additionalInfo || '';
                
                // Photo
                if (person.photo) {
                    this.elements.previewImage.src = person.photo;
                    this.elements.photoPreview.style.display = 'block';
                }
                
                // Mettre à jour les sélecteurs
                setTimeout(() => {
                    document.getElementById('father').value = person.father || '';
                    document.getElementById('mother').value = person.mother || '';
                    
                    if (person.spouses && person.spouses.length > 0) {
                        person.spouses.forEach(spouseId => {
                            const option = Array.from(document.getElementById('spouses').options)
                                .find(opt => opt.value === spouseId);
                            if (option) option.selected = true;
                        });
                    }
                }, 100);
                
                this.switchTab('form');
                this.hideModal();
            },
            
            // Afficher le modal
            showModal() {
                this.elements.personModal.style.display = 'flex';
            },
            
            // Cacher le modal
            hideModal() {
                this.elements.personModal.style.display = 'none';
            },
            
            // Afficher une notification
            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.remove()">&times;</button>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            },
            
            // Créer la barre d'état
            createStatusBar() {
                const statusBar = document.createElement('div');
                statusBar.id = 'statusBar';
                statusBar.style.cssText = `
                    position: fixed;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    background: var(--primary);
                    color: white;
                    padding: 8px 20px;
                    font-size: 0.9rem;
                    display: flex;
                    justify-content: space-between;
                    z-index: 1000;
                `;
                document.body.appendChild(statusBar);
                
                // Mettre à jour périodiquement
                setInterval(() => this.updateStatusBar(), 10000);
                this.updateStatusBar();
            },
            
            // Mettre à jour la barre d'état
            updateStatusBar() {
                const statusBar = document.getElementById('statusBar');
                if (!statusBar) return;
                
                const stats = DataManager.getStats();
                const lastSave = new Date(DataManager.familyTree.metadata.lastModified).toLocaleTimeString();
                
                statusBar.innerHTML = `
                    <span><i class="fas fa-users"></i> ${stats.totalPersons} personnes</span>
                    <span><i class="fas fa-layer-group"></i> Génération max: ${stats.maxGeneration}/15</span>
                    <span><i class="fas fa-save"></i> Dernière sauvegarde: ${lastSave}</span>
                `;
            },
            
            // Vérifier les performances
            checkPerformance() {
                const stats = DataManager.getStats();
                
                if (stats.totalPersons > CONFIG.MAX_PERSONS_WARNING) {
                    const warning = document.createElement('div');
                    warning.className = 'performance-warning';
                    warning.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i>
                        Votre arbre contient ${stats.totalPersons} personnes. Pour des performances optimales, 
                        envisagez d'utiliser les fonctionnalités de recherche et de filtrage.
                    `;
                    
                    const container = document.querySelector('.content-area');
                    if (container) {
                        container.prepend(warning);
                    }
                }
            },
            
            // Tutoriel
            showTutorial() {
                const hasSeenTutorial = localStorage.getItem('hasSeenTutorial');
                
                if (!hasSeenTutorial && DataManager.familyTree.persons.length === 0) {
                    setTimeout(() => {
                        if (confirm("Bienvenue dans votre application d'arbre généalogique !\n\nSouhaitez-vous voir un tutoriel rapide ?")) {
                            this.showNotification("TUTORIEL: 1. Ajoutez-vous 2. Ajoutez vos parents 3. Remontez les générations 4. Sauvegardez régulièrement", 'info');
                        }
                        localStorage.setItem('hasSeenTutorial', 'true');
                    }, 1000);
                }
            },
            
            // Déclencher l'import de fichier
            triggerFileImport() {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.json,.ged,.gedcom';
                fileInput.addEventListener('change', (e) => ExportManager.importData(e));
                fileInput.click();
            }
        };
        
        // ==============================================
        // MODULE DE VISUALISATION D'ARBRE
        // ==============================================
        const TreeVisualizer = {
            currentTree: null,
            
            renderTree() {
                const container = document.getElementById('treeVisualization');
                if (!container) return;
                
                const persons = DataManager.familyTree.persons;
                
                if (persons.length === 0) {
                    container.innerHTML = `
                        <p style="text-align: center; padding: 50px; color: #777;">
                            Ajoutez des personnes pour visualiser l'arbre généalogique.
                        </p>
                    `;
                    return;
                }
                
                container.innerHTML = `
                    <h3 style="text-align: center; margin-bottom: 20px; color: var(--primary);">
                        Arbre généalogique (${persons.length} personnes)
                    </h3>
                    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 20px;" id="treeNodes">
                        ${persons.slice(0, 50).map(person => this.createPersonNode(person)).join('')}
                    </div>
                    ${persons.length > 50 ? `
                        <div style="text-align: center; margin-top: 20px; color: #777;">
                            <p>${persons.length - 50} personnes supplémentaires (affichage limité à 50)</p>
                        </div>
                    ` : ''}
                `;
            },
            
            createPersonNode(person) {
                const birthYear = person.birthDate ? new Date(person.birthDate).getFullYear() : '?';
                const deathYear = person.deathDate ? new Date(person.deathDate).getFullYear() : '?';
                
                return `
                    <div class="person-card person-node" data-id="${person.id}" onclick="UIManager.viewPersonDetails('${person.id}')">
                        ${person.photo ? 
                            `<img src="${person.photo}" class="person-photo" alt="${person.firstName} ${person.lastName}">` : 
                            `<div class="person-photo" style="background-color: ${person.gender === 'M' ? '#3498db' : person.gender === 'F' ? '#e74c3c' : '#95a5a6'};">
                                <i class="fas fa-user"></i>
                            </div>`
                        }
                        <div class="person-name">${person.firstName} ${person.lastName}</div>
                        <div class="person-dates">${birthYear} - ${deathYear}</div>
                        <div class="person-location">${person.birthPlace || ''}</div>
                        <div style="font-size: 0.8rem; color: #777; margin-top: 5px;">Génération ${person.generation || '?'}</div>
                    </div>
                `;
            },
            
            renderInteractiveTree() {
                // Implémentation simplifiée pour l'exemple
                const container = document.getElementById('treeVisualization');
                if (!container) return;
                
                container.innerHTML = `
                    <div style="text-align: center; padding: 50px;">
                        <h3>Arbre Interactif D3.js</h3>
                        <p>Cette fonctionnalité nécessite une implémentation complète de D3.js</p>
                        <p>Pour l'instant, utilisez la vue standard.</p>
                        <button class="btn" onclick="TreeVisualizer.renderTree()">
                            <i class="fas fa-arrow-left"></i> Retour à la vue standard
                        </button>
                    </div>
                `;
            }
        };
        
        // ==============================================
        // MODULE D'ANALYSE DE LIGNÉES
        // ==============================================
        const LineageAnalyzer = {
            renderLineageChart() {
                const container = document.getElementById('treeVisualization');
                if (!container) return;
                
                container.innerHTML = `
                    <div style="text-align: center; padding: 50px;">
                        <h3>Analyse des Lignées</h3>
                        <p>Cette fonctionnalité est en cours de développement.</p>
                        <p>Elle permettra d'analyser les ascendants, descendants et les degrés de parenté.</p>
                        <button class="btn" onclick="TreeVisualizer.renderTree()">
                            <i class="fas fa-arrow-left"></i> Retour à l'arbre
                        </button>
                    </div>
                `;
            }
        };
        
        // ==============================================
        // MODULE D'EXPORT/IMPORT
        // ==============================================
        const ExportManager = {
            exportJSON() {
                const dataStr = JSON.stringify(DataManager.familyTree, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `arbre-genealogique-${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                UIManager.showNotification('Export JSON réussi', 'success');
            },
            
            exportGEDCOM() {
                // Implémentation simplifiée
                UIManager.showNotification('Export GEDCOM en cours de développement', 'info');
            },
            
            exportPDF() {
                // Implémentation simplifiée
                UIManager.showNotification('Export PDF en cours de développement', 'info');
            },
            
            importData(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                UIManager.showLoading('Import en cours...');
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (data.persons && Array.isArray(data.persons)) {
                            if (confirm(`Importer ${data.persons.length} personnes ? Cela remplacera vos données actuelles.`)) {
                                DataManager.familyTree = data;
                                DataManager.save();
                                UIManager.updateAll();
                                UIManager.updatePersonSelects();
                                UIManager.showNotification(`Import réussi ! ${data.persons.length} personnes chargées.`, 'success');
                            }
                        } else {
                            throw new Error('Format invalide');
                        }
                    } catch (error) {
                        console.error('Erreur import:', error);
                        UIManager.showNotification('Erreur lors de l\'import : ' + error.message, 'error');
                    } finally {
                        UIManager.hideLoading();
                    }
                };
                
                reader.readAsText(file);
            }
        };
        
        // ==============================================
        // INITIALISATION DE L'APPLICATION
        // ==============================================
        document.addEventListener('DOMContentLoaded', () => {
            // Initialiser les données
            DataManager.init();
            
            // Initialiser l'interface
            UIManager.init();
            
            // Sauvegarde automatique
            setInterval(() => {
                DataManager.save();
            }, CONFIG.AUTO_SAVE_INTERVAL);
            
            // Backup automatique
            setInterval(() => {
                const backupKey = 'familyTreeBackup_' + new Date().toISOString().slice(0, 10);
                localStorage.setItem(backupKey, JSON.stringify(DataManager.familyTree));
                
                // Nettoyer les anciens backups
                const keys = Object.keys(localStorage).filter(key => key.startsWith('familyTreeBackup_'));
                if (keys.length > CONFIG.BACKUP_DAYS) {
                    keys.sort().slice(0, keys.length - CONFIG.BACKUP_DAYS).forEach(key => {
                        localStorage.removeItem(key);
                    });
                }
            }, 24 * 60 * 60 * 1000);
            
            console.log('Application initialisée avec succès');
        });
    </script>
</body>
</html>
